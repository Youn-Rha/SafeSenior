## 🧭 개요

`fall_detection.py`는 CNN-LSTM 기반 딥러닝 모델을 활용해 mmWave 레이더 센서로부터 수집된 시계열 데이터를 분석하고, **실시간 낙상 여부를 판단**하는 기능을 담당합니다. 추적된 클러스터 데이터를 기반으로 일정 시간동안의 움직임 패턴을 분석하여 낙상 징후를 감지합니다.

---

## 🧠 동작 방식 요약

1. **트래킹된 객체들의 좌표 및 속도 정보를 시간 순으로 누적**
2. **CNN 계층**으로 공간적 특징 추출
3. **LSTM 계층**으로 시간적 움직임 패턴 분석
4. **최종 소프트맥스 출력**으로 낙상 여부 예측 (`Fall`, `Walk`, `Stand Up ` 등)

---

## 📁 구성 요소 설명

| 항목                         | 설명                                                 |
| -------------------------- | -------------------------------------------------- |
| `FallDetection`            | 전체 낙상 감지 파이프라인 클래스. 모델 로드, 입력 시퀀스 관리, 예측 쓰레드 실행 담당 |
| `InferThread(QThread)`     | 예측 전용 스레드. 클러스터링, 시퀀스 전처리, 모델 추론 및 결과 emit 수행      |
| `cluster_data()`           | 프레임별 DBSCAN 클러스터링 후, noise 제거 및 전처리 수행             |
| `track_clusters()`         | 클러스터 간 프레임 연결 (전역 클러스터 ID 생성)                      |
| `prepare_data()`           | 시퀀스 데이터를 모델 입력 형태로 슬라이딩 윈도우 생성                     |
| `run_model()`              | CNN-LSTM 모델을 이용한 실제 낙상 추론                          |
| `cartesian_to_spherical()` | 조건부 수행되는 좌표계 변환 함수 (구면 변환)                         |

---

## 🔍 입력 데이터 형식

* shape: `(60, 10, 32, 32)` 또는 `(N, 5)` 시계열 형태의 DataFrame
* 각 시퀀스는 특정 클러스터 ID에 대한 움직임의 시간 축 변화

---

## 📤 출력 결과 예시

```json
{
  "cluster_id": 3,
  "prediction": "Fall",
  "confidence": 0.92
}
```

---

## 🧼 노이즈 필터링

* 예측 결과에서 신뢰도가 낮거나, 일부 프레임에서 클러스터링 실패 시 노이즈 카운트 증가
* `MAX_SEQ_NOISE_LEN`을 초과할 경우, 전체 시퀀스를 초기화하여 학습 입력 단절 방지

---

## 🎯 활용 목적

* 실시간 낙상 감지 경고 시스템 구축
* 낙상 발생 직후 대응 시간 단축
* 고령자 안전 모니터링 시스템의 핵심 기능 중 하나

---

## 🔧 사용 전제 조건

* 모델 파일(`model_seq5_spher.h5` 등)이 `model/` 폴더에 존재해야 함
* Kalman 필터 기반 트래킹 후 클러스터 ID별로 시퀀스가 정리되어야 함
* `DEBUG_AI_INPUT_CONVERSION` 값에 따라 좌표계 변환 (`cartesian_to_spherical`) 수행 가능

---

## 📝 참고 문서

* [`addCluster.md`](addCluster.md): 객체 트래킹 및 전처리 흐름
* [`README.md`](README.md): 전체 시스템 구성 개요

> CNN-LSTM 모델은 추후 고도화를 통해 다중 인원 인식, 행동 분류 다양화로 확장 가능
